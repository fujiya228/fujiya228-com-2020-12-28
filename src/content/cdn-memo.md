---
アセットをCDNで配信をするねらい
本題の前に、そもそもアセットをCDNで配信するねらいを整理しておきます。主に3つのねらいがありますが、どれもみてね特有のものではなく一般化できるポイントだと思います。

1. UXの向上・SEOの改善
予めコンパイルしたアセットをCDNで配信することで、Railsから直接アセットを配信する場合に比べてアセットのレスポンスタイムが改善します。これによりWEBページの描画がスピードアップし、UXの向上・SEOの改善が期待できます。

2. サーバーの負荷軽減
クライアントからのリクエストのうち、アセットへのアクセスがCDN宛になるのでRailsで処理する必要がなくなります。

Railsで処理する必要があるリクエスト数が減れば、その分サーバーの負荷軽減が期待できます。結果的に、コンピュートリソースの削減によるコスト削減や、レスポンスタイムの向上など様々な改善が期待できます。

3. スケールアウトの高速化
例えば、Railsが実行される各サーバー上で、Rails起動前にアセットをプリコンパイルしておくような構成を考えます。このような構成でスケールイン・アウトが頻繁に発生する場合、同じアセットを重複してプリコンパイルすることになり、多くの時間を無駄に消費してしまいます。
一方でアセットをCDNで配信する場合、同じアセットを重複してプリコンパイルする必要はなく、非常に効率的になります。

ところで、スケールアウトの遅さは平常時はあまり気にならないかもしれませんが、メディア露出などユーザーアクセスがスパイクするような場合に命取りになりかねません。自分たちのサービスが多くの人に興味を持ってもらったタイミングでサービスがダウンしてしまったら悲しいですよね 😢

システム構成
「家族アルバム みてね」のSREチームの紹介と取り組み にて紹介しているように、みてねのインフラはAWS上に構築されています。このため、プリコンパイルしたアセットの保存先はAmazon S3、CDNはAmazon CloudFrontを利用しています。

デプロイフロー

1. デプロイフロー概要
開発者がGitHub上のリポジトリにpushをすると、GitHub Actions上でjobが実行されます。jobの処理は大雑把に下記の処理が行われます。

Railsの起動やrake taskを実行するために必要な前処理
プリコンパイル
成果物をS3にPUT
ここで重要なポイントは public/assets/.sprockets-manifest-*.json を public/assets/.sprockets-manifest-${GIT_COMMIT_HASH}.json にリネームしてからS3にPUTすることです。変数名にあるとおりgitのcommit hashをファイル名に変更しておくことで、サーバー上でS3から入手すべきmanifestファイルを特定できるようにしています。

このとき、注意点が2つあります。

1つ目は、gitのcommit hashはリポジトリ全体のものではなく、アセットに関係のあるファイルに絞ったcommit hashを使うということです。これによって、後述するプリコンパイルのスキップをより効率的に行えるようにしています。
具体的には下記のコマンドのようにすることで対象のファイルを絞ることができます。また、リポジトリ固有のファイルでアセットに関係のあるファイルがある場合、更に対象を追加する必要があります。

```
$ git log --pretty=%H -n 1 \
  Gemfile.lock \
  yarn.lock \
  app/assets \
  app/javascript \
  # アセットパイプライン関連のconfigを変更した場合にもプリコンパイルが実行されるために
  # config/environmentsも対象としています。
  config/environments \
  public \
  vendor/assets
```

2つ目は、入手したmanifestファイルのcommit hash部分は32文字にする必要がある点です。sprockets gemのlib/sprockets/manifest_utils.rbを確認すると、32文字であることを期待していることが分かります。

また、みてねではsprocketsに加えてwebpackerを並行して利用していますが、同じようにmanifestのファイル名にgitのcommit hashを埋め込んで処理をしています。

アセットの配信フロー

2. アセットの配信フロー概要
ユーザーからWEBページへアクセスがあると、図のように通常のHTTPリクエストはサーバーへと向かいますが、アセットへのHTTPリクエストはCloudFrontに向くようになっています。

みてねの場合、static.mitene.us というドメインで図中のアセット配信用CloudFrontにアクセスできるようになっています。例えば https://mitene.us にアクセスすると、static.mitene.usドメインからアセットを取得していること・アセットがS3をオリジンとしてCloudFrontから配信されている様子を確認することができます。


3. アセットがCloudFrontから配信されている様子
デプロイの高速化のためのさらなる工夫
ここまでの基本的な実装に加え、デプロイの高速化のために以下のような工夫もしています。

プリコンパイルのスキップ
GitHub Actionsのjobのなるべく早いタイミングで、S3上に「これから生成しようとしている」manifestファイルが既に存在しているかどうかをチェックします。そして存在した場合、プリコンパイルをスキップすることで重複してプリコンパイルを実行する無駄を省いています。

みてねの場合、gitのcommit hashを知ることができれば「これから生成しようとしている」manifestファイルのファイル名を特定することができます。このため、プリコンパイルを実行する前にスキップするかどうかを決定することができるようになっています。

キャッシュの活用
これは単純で、GitHub Actionsの actions/cache を利用して tmp/cache/assets ディレクトリをキャッシュしています。これによって、プリコンパイルの時間が約1/2（！）になりました🎉

キャッシュの詳細についてはRailsガイドの「アセットのキャッシュストア」を参照してください。

みてねではSREはもちろん、モバイルアプリ開発・レコメンド機能の研究開発など様々なポジションでエンジニアを積極採用中です。

一緒に世界中の家族の“こころのインフラ”をつくりましょう！

---

# 考えること

- 構成
  - CIの構成
    - ビルドの手順（なるべく高速化できるようにしておきたい&効率よくやりたい）
    - 環境ごとに分けるようにしておかないといけない
  - CloudFront の設定
    - ちなみに以下はcopilotによる生成w
      - キャッシュの設定
      - リダイレクトの設定
      - リクエストヘッダーの設定
      - レスポンスヘッダーの設定
      - エラーページの設定
      - ログの設定
      - オリジンの設定
      - オリジンリクエストポリシーの設定
      - キャッシュポリシーの設定
      - ディストリビューションの設定
    - CloudFrontの料金調査
    - CloudFrontにWAFの設定
  - S3バケットの作成（各環境）（terraform）

# CloudFrontとは

Amazon CloudFront は、ユーザーへの静的および動的なウェブコンテンツ (.html、.css、.js、イメージファイルなど) の配信を高速化するウェブサービスです。CloudFront では、エッジロケーションというデータセンターの世界的ネットワークを経由してコンテンツを配信します。CloudFront でサービスを提供しているコンテンツをユーザーがリクエストすると、リクエストはエッジロケーションにルーティングされ、レイテンシー (遅延時間) が最小になります。これにより、コンテンツは可能な限り最高のパフォーマンスで配信されます。
コンテンツがエッジロケーション内に最も低いレイテンシーですでに存在している場合、CloudFront はそのコンテンツを即時に配信します。
コンテンツがこのエッジロケーションに存在しない場合、CloudFront は、コンテンツの最終バージョンのソースとして識別されている Amazon S3 バケット、MediaPackage チャネル、または HTTP サーバー (たとえば、ウェブサーバー) などの定義されたオリジンからコンテンツを取り込みます。
たとえば、イメージが CloudFront からではなく従来のウェブサーバーから供給されているとします。たとえば、sunsetphoto.png というイメージを、URL https://example.com/sunsetphoto.png を使用して提供するとします。
ユーザーは簡単にこの URL にアクセスしてそのイメージを表示できます。ただし、そのイメージが見つかるまで、リクエストがネットワークから別のネットワークに (インターネットを構成する相互接続ネットワークの複雑な集合経由で) ルーティングされたということを、おそらくユーザーは認識しません。
CloudFront は、コンテンツを最良の方法で供給できるエッジロケーションに各ユーザーリクエストを AWS バックボーンネットワーク経由でルーティングすることで、コンテンツの配信を高速化します。通常、これはビューワーに最も高速に配信できる CloudFront エッジサーバーです。AWS ネットワークを使用することでユーザーのリクエストが通過しなければならないネットワークの数が大幅に減少するので、パフォーマンスが向上します。ユーザーが経験するレイテンシー (ファイルの最初のバイトがロードされるまでの時間) が低くなり、データ転送速度が高くなります。
お客様のファイル (オブジェクトとしても知られる) のコピーが世界中の複数のエッジロケーションに保持される (つまりキャッシュされる) ので、信頼性と可用性の向上も得られます。

# CloudFrontとWAF

https://docs.aws.amazon.com/ja_jp/waf/latest/developerguide/cloudfront-features.html

# 初めてのCloudFront

キャッシュ動作を使用すると、ウェブサイトにあるファイルの特定の URL パスパターンに応じてさまざまな CloudFront 機能を構成できます。たとえば、CloudFront のオリジンサーバーとして使用しているウェブサーバーの .jpg ディレクトリ内にあるすべての images ファイルに 1 つのキャッシュ動作を適用することができます。キャッシュ動作ごとに構成可能な機能には以下のようなものがあります。

- パスパターン。
- CloudFront ディストリビューションに対して複数のオリジンを構成した場合、CloudFront でリクエストをどのオリジンに転送するか。
- クエリ文字列をオリジンに転送するかどうか。
- 指定したファイルへのアクセスに署名付き URL を必要とするかどうか。
- これらのファイルへのアクセスに HTTPS を使用するようユーザーに要求するかどうか。
- オリジンがファイルに追加する Cache-Control ヘッダーの値に関係なく、これらのファイルを CloudFront キャッシュに保持する最小時間。